{"_path":"/articles/home-lab","_dir":"articles","_draft":false,"_partial":false,"_locale":"","title":"我的 home lab","description":"我的自管伺服器的架構與解決辦法","category":"server","date":"2022-01-01","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"實體機架構"},"children":[{"type":"text","value":"實體機架構"}]},{"type":"element","tag":"vue-mermaid","props":{"code":"\ngraph LR\n isp(ISP) --- router\n router((路由器)) --- storage & vm-server & home\n home[Home Group]\n subgraph Server Group\n     storage[儲存] == Fiber === vm-server\n     subgraph DMZ\n         vm-server[VM]\n     end\n end\n"},"children":[]},{"type":"element","tag":"h2","props":{"id":"路由器"},"children":[{"type":"text","value":"路由器"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我採用了 RouterOS，因為可以使用相對低的成本做到專業路由器的設定。"}]},{"type":"element","tag":"h2","props":{"id":"儲存"},"children":[{"type":"text","value":"儲存"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在眾多專為儲存設計的作業系統中我最終採用 DIY 建置的方案。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Debian\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"XanMod kernel LTS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"OpenZFS"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"iSCSI: LIO"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Cockpit\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/optimans/cockpit-zfs-manager","rel":["nofollow"]},"children":[{"type":"text","value":"ZFS Manager"}]}]}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"原本是想選擇 FreeNAS，畢竟 iXsystems 在 FreeNAS 上做了不少優化。但 FreeBSD 的社群正在萎縮、維護速度趕不上 Linux。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用 XanMod kernel 是因為在加上 performance profile 之後擁有更佳的性能。\n而 iSCSI 採用 LIO 是因為它是執行在 kernel 內、支援各種協定，且它可以直接與 Proxmox VE 整合 (ZFS over iSCSI)。"}]},{"type":"element","tag":"h3","props":{"id":"openzfs"},"children":[{"type":"text","value":"OpenZFS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"非常強大，支援快照、區塊壓縮、RAM cache (ARC)、SSD cache (L2ARC) 等功能，且自有的 zpool 管理方式非常方便。"}]},{"type":"element","tag":"h3","props":{"id":"cockpit"},"children":[{"type":"text","value":"Cockpit"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"近期社群非常活躍的 Web 管理介面專案，它可以很容易的安裝第三方插件。"}]},{"type":"element","tag":"h2","props":{"id":"vm"},"children":[{"type":"text","value":"VM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我選擇了 Proxmox VE，因為它是開源的而且有非常方便管理的 Web UI。\n並且由於該主機是自組的、沒有辦法放那麼多硬碟，所以我把儲存分離出去，為了保障資料傳輸還設定了直連光纖。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"所有的應用服務都是在這台上面開 LXC 或 VM 來解決。"}]},{"type":"element","tag":"h2","props":{"id":"分區管制"},"children":[{"type":"text","value":"分區管制"}]},{"type":"element","tag":"h3","props":{"id":"home-group"},"children":[{"type":"text","value":"Home group"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"供給家裡使用，設定 DHCP 與 NAT 且獨立的網段。"}]},{"type":"element","tag":"h3","props":{"id":"server-group"},"children":[{"type":"text","value":"Server group"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"供給伺服器使用，獨立的網段且有分區管制，僅 PVE 內。"}]},{"type":"element","tag":"h1","props":{"id":"應用層架構"},"children":[{"type":"text","value":"應用層架構"}]},{"type":"element","tag":"vue-mermaid","props":{"code":"\ngraph TB\n envoy -- WAF --> iis & http1 & http2\n envoy --> other-services\n rdp-proxy --> rdp & vnc\n subgraph front-vm [Bastion host VM]\n     envoy(envoy proxy)\n     rdp-proxy(RDP proxy)\n end\n subgraph windows-vm [Windows VM]\n     rdp(RDP)\n     iis(IIS)\n end\n subgraph linux-1 [Linux VM 1]\n     vnc(VNC)\n     http1(HTTP)\n end\n subgraph linux-2 [Linux VM 2]\n     http2(HTTP)\n end\n subgraph linux-3 [Linux VM 3]\n     other-services(Other services)\n end\n"},"children":[]},{"type":"element","tag":"h2","props":{"id":"bastion-host"},"children":[{"type":"text","value":"Bastion host"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"採用類似雲端的管理方式，由 bastion host 統一對外。"}]},{"type":"element","tag":"h3","props":{"id":"envoy-proxy"},"children":[{"type":"text","value":"envoy proxy"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"envoy proxy 是 CNCF 的一個專案，就是專門進行高效能代理服務用的伺服器。"}]},{"type":"element","tag":"h4","props":{"id":"modsecurity-filter"},"children":[{"type":"text","value":"ModSecurity filter"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"為了安全性，我在 HTTP 服務加上 ModSecurity filter 作為 WAF。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個模組雖然有找到現成的，但似乎有段時間沒維護且留下了一些 TODO code，所以我花了時間整理了一下。envoy proxy 內部程式碼似乎沒有文件，於是我是一層一層追蹤來找到正確寫法的。"}]},{"type":"element","tag":"h3","props":{"id":"rdp-proxy"},"children":[{"type":"text","value":"RDP proxy"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我找到了 "},{"type":"element","tag":"a","props":{"href":"https://github.com/wallix/redemption","rel":["nofollow"]},"children":[{"type":"text","value":"redemption"}]},{"type":"text","value":" 這個專案可以在 Linux 上建置統一對外用的 proxy，所以我選用這個並依他的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"passthrough.py"}]},{"type":"text","value":" 範本加寫了限制連線範圍的規則。"}]},{"type":"element","tag":"h4","props":{"id":"auto-ban"},"children":[{"type":"text","value":"auto ban"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"passthrough.py"}]},{"type":"text","value":" 這邊辨識連線目標為範圍外時會記錄下來，再透過 fail2ban 進行封鎖。"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"路由器","depth":2,"text":"路由器"},{"id":"儲存","depth":2,"text":"儲存","children":[{"id":"openzfs","depth":3,"text":"OpenZFS"},{"id":"cockpit","depth":3,"text":"Cockpit"}]},{"id":"vm","depth":2,"text":"VM"},{"id":"分區管制","depth":2,"text":"分區管制","children":[{"id":"home-group","depth":3,"text":"Home group"},{"id":"server-group","depth":3,"text":"Server group"}]},{"id":"bastion-host","depth":2,"text":"Bastion host","children":[{"id":"envoy-proxy","depth":3,"text":"envoy proxy"},{"id":"rdp-proxy","depth":3,"text":"RDP proxy"}]}]}},"_type":"markdown","_id":"content:articles:home-lab.md","_source":"content","_file":"articles/home-lab.md","_stem":"articles/home-lab","_extension":"md"}