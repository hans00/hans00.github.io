[{"data":1,"prerenderedAt":292},["ShallowReactive",2],{"article-home-lab":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"category":10,"date":11,"body":12,"_type":286,"_id":287,"_source":288,"_file":289,"_stem":290,"_extension":291},"/articles/home-lab","articles",false,"","我的 home lab","我的自管伺服器的架構與解決辦法","server","2022-01-01",{"type":13,"children":14,"toc":268},"root",[15,23,28,34,40,45,50,98,103,108,114,119,125,130,136,141,146,151,157,162,168,173,178,182,188,193,199,204,211,216,221,227,250,256],{"type":16,"tag":17,"props":18,"children":20},"element","h1",{"id":19},"實體機架構",[21],{"type":22,"value":19},"text",{"type":16,"tag":24,"props":25,"children":27},"vue-mermaid",{"code":26},"\ngraph LR\n isp(ISP) --- router\n router((路由器)) --- storage & vm-server & home\n home[Home Group]\n subgraph Server Group\n     storage[儲存] == Fiber === vm-server\n     subgraph DMZ\n         vm-server[VM]\n     end\n end\n",[],{"type":16,"tag":29,"props":30,"children":32},"h2",{"id":31},"路由器",[33],{"type":22,"value":31},{"type":16,"tag":35,"props":36,"children":37},"p",{},[38],{"type":22,"value":39},"我採用了 RouterOS，因為可以使用相對低的成本做到專業路由器的設定。",{"type":16,"tag":29,"props":41,"children":43},{"id":42},"儲存",[44],{"type":22,"value":42},{"type":16,"tag":35,"props":46,"children":47},{},[48],{"type":22,"value":49},"在眾多專為儲存設計的作業系統中我最終採用 DIY 建置的方案。",{"type":16,"tag":51,"props":52,"children":53},"ul",{},[54],{"type":16,"tag":55,"props":56,"children":57},"li",{},[58,60],{"type":22,"value":59},"Debian\n",{"type":16,"tag":51,"props":61,"children":62},{},[63,68,73,78],{"type":16,"tag":55,"props":64,"children":65},{},[66],{"type":22,"value":67},"XanMod kernel LTS",{"type":16,"tag":55,"props":69,"children":70},{},[71],{"type":22,"value":72},"OpenZFS",{"type":16,"tag":55,"props":74,"children":75},{},[76],{"type":22,"value":77},"iSCSI: LIO",{"type":16,"tag":55,"props":79,"children":80},{},[81,83],{"type":22,"value":82},"Cockpit\n",{"type":16,"tag":51,"props":84,"children":85},{},[86],{"type":16,"tag":55,"props":87,"children":88},{},[89],{"type":16,"tag":90,"props":91,"children":95},"a",{"href":92,"rel":93},"https://github.com/optimans/cockpit-zfs-manager",[94],"nofollow",[96],{"type":22,"value":97},"ZFS Manager",{"type":16,"tag":35,"props":99,"children":100},{},[101],{"type":22,"value":102},"原本是想選擇 FreeNAS，畢竟 iXsystems 在 FreeNAS 上做了不少優化。但 FreeBSD 的社群正在萎縮、維護速度趕不上 Linux。",{"type":16,"tag":35,"props":104,"children":105},{},[106],{"type":22,"value":107},"使用 XanMod kernel 是因為在加上 performance profile 之後擁有更佳的性能。\n而 iSCSI 採用 LIO 是因為它是執行在 kernel 內、支援各種協定，且它可以直接與 Proxmox VE 整合 (ZFS over iSCSI)。",{"type":16,"tag":109,"props":110,"children":112},"h3",{"id":111},"openzfs",[113],{"type":22,"value":72},{"type":16,"tag":35,"props":115,"children":116},{},[117],{"type":22,"value":118},"非常強大，支援快照、區塊壓縮、RAM cache (ARC)、SSD cache (L2ARC) 等功能，且自有的 zpool 管理方式非常方便。",{"type":16,"tag":109,"props":120,"children":122},{"id":121},"cockpit",[123],{"type":22,"value":124},"Cockpit",{"type":16,"tag":35,"props":126,"children":127},{},[128],{"type":22,"value":129},"近期社群非常活躍的 Web 管理介面專案，它可以很容易的安裝第三方插件。",{"type":16,"tag":29,"props":131,"children":133},{"id":132},"vm",[134],{"type":22,"value":135},"VM",{"type":16,"tag":35,"props":137,"children":138},{},[139],{"type":22,"value":140},"我選擇了 Proxmox VE，因為它是開源的而且有非常方便管理的 Web UI。\n並且由於該主機是自組的、沒有辦法放那麼多硬碟，所以我把儲存分離出去，為了保障資料傳輸還設定了直連光纖。",{"type":16,"tag":35,"props":142,"children":143},{},[144],{"type":22,"value":145},"所有的應用服務都是在這台上面開 LXC 或 VM 來解決。",{"type":16,"tag":29,"props":147,"children":149},{"id":148},"分區管制",[150],{"type":22,"value":148},{"type":16,"tag":109,"props":152,"children":154},{"id":153},"home-group",[155],{"type":22,"value":156},"Home group",{"type":16,"tag":35,"props":158,"children":159},{},[160],{"type":22,"value":161},"供給家裡使用，設定 DHCP 與 NAT 且獨立的網段。",{"type":16,"tag":109,"props":163,"children":165},{"id":164},"server-group",[166],{"type":22,"value":167},"Server group",{"type":16,"tag":35,"props":169,"children":170},{},[171],{"type":22,"value":172},"供給伺服器使用，獨立的網段且有分區管制，僅 PVE 內。",{"type":16,"tag":17,"props":174,"children":176},{"id":175},"應用層架構",[177],{"type":22,"value":175},{"type":16,"tag":24,"props":179,"children":181},{"code":180},"\ngraph TB\n envoy -- WAF --> iis & http1 & http2\n envoy --> other-services\n rdp-proxy --> rdp & vnc\n subgraph front-vm [Bastion host VM]\n     envoy(envoy proxy)\n     rdp-proxy(RDP proxy)\n end\n subgraph windows-vm [Windows VM]\n     rdp(RDP)\n     iis(IIS)\n end\n subgraph linux-1 [Linux VM 1]\n     vnc(VNC)\n     http1(HTTP)\n end\n subgraph linux-2 [Linux VM 2]\n     http2(HTTP)\n end\n subgraph linux-3 [Linux VM 3]\n     other-services(Other services)\n end\n",[],{"type":16,"tag":29,"props":183,"children":185},{"id":184},"bastion-host",[186],{"type":22,"value":187},"Bastion host",{"type":16,"tag":35,"props":189,"children":190},{},[191],{"type":22,"value":192},"採用類似雲端的管理方式，由 bastion host 統一對外。",{"type":16,"tag":109,"props":194,"children":196},{"id":195},"envoy-proxy",[197],{"type":22,"value":198},"envoy proxy",{"type":16,"tag":35,"props":200,"children":201},{},[202],{"type":22,"value":203},"envoy proxy 是 CNCF 的一個專案，就是專門進行高效能代理服務用的伺服器。",{"type":16,"tag":205,"props":206,"children":208},"h4",{"id":207},"modsecurity-filter",[209],{"type":22,"value":210},"ModSecurity filter",{"type":16,"tag":35,"props":212,"children":213},{},[214],{"type":22,"value":215},"為了安全性，我在 HTTP 服務加上 ModSecurity filter 作為 WAF。",{"type":16,"tag":35,"props":217,"children":218},{},[219],{"type":22,"value":220},"這個模組雖然有找到現成的，但似乎有段時間沒維護且留下了一些 TODO code，所以我花了時間整理了一下。envoy proxy 內部程式碼似乎沒有文件，於是我是一層一層追蹤來找到正確寫法的。",{"type":16,"tag":109,"props":222,"children":224},{"id":223},"rdp-proxy",[225],{"type":22,"value":226},"RDP proxy",{"type":16,"tag":35,"props":228,"children":229},{},[230,232,239,241,248],{"type":22,"value":231},"我找到了 ",{"type":16,"tag":90,"props":233,"children":236},{"href":234,"rel":235},"https://github.com/wallix/redemption",[94],[237],{"type":22,"value":238},"redemption",{"type":22,"value":240}," 這個專案可以在 Linux 上建置統一對外用的 proxy，所以我選用這個並依他的 ",{"type":16,"tag":242,"props":243,"children":245},"code",{"className":244},[],[246],{"type":22,"value":247},"passthrough.py",{"type":22,"value":249}," 範本加寫了限制連線範圍的規則。",{"type":16,"tag":205,"props":251,"children":253},{"id":252},"auto-ban",[254],{"type":22,"value":255},"auto ban",{"type":16,"tag":35,"props":257,"children":258},{},[259,261,266],{"type":22,"value":260},"在 ",{"type":16,"tag":242,"props":262,"children":264},{"className":263},[],[265],{"type":22,"value":247},{"type":22,"value":267}," 這邊辨識連線目標為範圍外時會記錄下來，再透過 fail2ban 進行封鎖。",{"title":7,"searchDepth":269,"depth":269,"links":270},2,[271,272,277,278,282],{"id":31,"depth":269,"text":31},{"id":42,"depth":269,"text":42,"children":273},[274,276],{"id":111,"depth":275,"text":72},3,{"id":121,"depth":275,"text":124},{"id":132,"depth":269,"text":135},{"id":148,"depth":269,"text":148,"children":279},[280,281],{"id":153,"depth":275,"text":156},{"id":164,"depth":275,"text":167},{"id":184,"depth":269,"text":187,"children":283},[284,285],{"id":195,"depth":275,"text":198},{"id":223,"depth":275,"text":226},"markdown","content:articles:home-lab.md","content","articles/home-lab.md","articles/home-lab","md",1771108310341]