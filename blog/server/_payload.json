[{"data":1,"prerenderedAt":624},["ShallowReactive",2],{"category-server":3},[4,355],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"category":11,"date":12,"body":13,"_type":349,"_id":350,"_source":351,"_file":352,"_stem":353,"_extension":354},"/articles/homelab-v2","articles",false,"","HomeLab v2.0 架構大遷移：告別存算分離，擁抱 Ubuntu + ZFS + AI Copilot 全能單機","告別存算分離，擁抱 Ubuntu + ZFS + Cockpit + AI Copilot 的全能單機 HomeLab v2.0 架構分享。","server","2024-02-14",{"type":14,"children":15,"toc":346},"root",[16,25,31,36,62,74,85,91,102,114,120,139,151,157,162,186,198,204,209,231,249,261,294,321,326,331,336,341],{"type":17,"tag":18,"props":19,"children":21},"element","h1",{"id":20},"前言為什麼要重構",[22],{"type":23,"value":24},"text","前言：為什麼要重構？",{"type":17,"tag":26,"props":27,"children":28},"p",{},[29],{"type":23,"value":30},"熟悉我的朋友都知道，我的上一代 HomeLab (v1) 是一個經典的「存算分離」架構。那時候為了追求所謂的 Enterprise-grade（企業級）配置，我把儲存交給了 TrueNAS，運算則由 Proxmox VE (PVE) 負責，兩者透過網路協定連接。",{"type":17,"tag":26,"props":32,"children":33},{},[34],{"type":23,"value":35},"看起來很美好，對吧？但隨著時間推移，現實的「維護成本」狠狠地打醒了我：",{"type":17,"tag":37,"props":38,"children":39},"ol",{},[40,52],{"type":17,"tag":41,"props":42,"children":43},"li",{},[44,50],{"type":17,"tag":45,"props":46,"children":47},"strong",{},[48],{"type":23,"value":49},"功耗焦慮",{"type":23,"value":51},"：為了這個分離架構，我必須維持多台機器運作。看著電費單，我不禁懷疑：對於現在的負載需求，真的需要兩台機器空轉嗎？",{"type":17,"tag":41,"props":53,"children":54},{},[55,60],{"type":17,"tag":45,"props":56,"children":57},{},[58],{"type":23,"value":59},"維護黑洞",{"type":23,"value":61},"：PVE 的 FreeNAS (TrueNAS) 儲存模組近年來維護狀況不佳，每次升級都像是在走鋼索，一旦 connection 出問題，整個 VM Cluster 就癱瘓。",{"type":17,"tag":26,"props":63,"children":64},{},[65,67,72],{"type":23,"value":66},"於是，我決定進行一場徹底的「斷捨離」。我的需求已經變了，不再需要多機備援的複雜度。是時候回歸本質：",{"type":17,"tag":45,"props":68,"children":69},{},[70],{"type":23,"value":71},"高效、單機、智慧化",{"type":23,"value":73},"。",{"type":17,"tag":26,"props":75,"children":76},{},[77,79,84],{"type":23,"value":78},"歡迎來到我的 ",{"type":17,"tag":45,"props":80,"children":81},{},[82],{"type":23,"value":83},"HomeLab v2.0",{"type":23,"value":73},{"type":17,"tag":18,"props":86,"children":88},{"id":87},"核心思想一化繁為簡hybrid-all-in-one",[89],{"type":23,"value":90},"核心思想一：化繁為簡，Hybrid All-in-One",{"type":17,"tag":26,"props":92,"children":93},{},[94,96,101],{"type":23,"value":95},"v2 的首要目標只有一個：",{"type":17,"tag":45,"props":97,"children":98},{},[99],{"type":23,"value":100},"存算一體 (Hybrid Storage/VM/Container)",{"type":23,"value":73},{"type":17,"tag":26,"props":103,"children":104},{},[105,107,112],{"type":23,"value":106},"我拋棄了專用的儲存 OS 和虛擬化 OS，轉而採用通用性最強的 ",{"type":17,"tag":45,"props":108,"children":109},{},[110],{"type":23,"value":111},"Ubuntu",{"type":23,"value":113}," 作為基底。這不僅大幅降低了硬體需求和功耗，更讓我擁有對系統底層由上到下完整的控制權。不需要再煩惱跨機器的 iSCSI 或 NFS 延遲，所有的 I/O 都在本機內完成，速度飛快且穩定。",{"type":17,"tag":18,"props":115,"children":117},{"id":116},"核心思想二ubuntu-zfs-cockpit-的黃金三角",[118],{"type":23,"value":119},"核心思想二：Ubuntu + ZFS + Cockpit 的黃金三角",{"type":17,"tag":26,"props":121,"children":122},{},[123,125,130,132,137],{"type":23,"value":124},"在作業系統層，我選擇了 ",{"type":17,"tag":45,"props":126,"children":127},{},[128],{"type":23,"value":129},"Ubuntu Server",{"type":23,"value":131}," 搭配 ",{"type":17,"tag":45,"props":133,"children":134},{},[135],{"type":23,"value":136},"ZFS",{"type":23,"value":138},"。\nZFS 的強大無須多言（Snapshot, Compression, ARC），在 Ubuntu 上它的支援度極高。",{"type":17,"tag":26,"props":140,"children":141},{},[142,144,149],{"type":23,"value":143},"而在管理介面方面，我沒有選擇厚重的 Web 介面，而是選擇了 ",{"type":17,"tag":45,"props":145,"children":146},{},[147],{"type":23,"value":148},"Cockpit",{"type":23,"value":150},"。\nCockpit 非常輕量，它忠實地反應了 Linux 系統的狀態，不會像某些管理面板一樣在背後魔改系統設定檔。這讓我在享受 Web UI 便利的同時，依然能保留隨時切回 Terminal 手動操作的彈性。",{"type":17,"tag":18,"props":152,"children":154},{"id":153},"核心思想三徹底的-rootless-vm-container",[155],{"type":23,"value":156},"核心思想三：徹底的 Rootless (VM & Container)",{"type":17,"tag":26,"props":158,"children":159},{},[160],{"type":23,"value":161},"安全性與隔離性是 v2 架構的另一個重點。在 Cockpit 上，我充分利用了現有的 Plugin 體系：",{"type":17,"tag":163,"props":164,"children":165},"ul",{},[166,176],{"type":17,"tag":41,"props":167,"children":168},{},[169,174],{"type":17,"tag":45,"props":170,"children":171},{},[172],{"type":23,"value":173},"Virtual Machines (libvirt)",{"type":23,"value":175},"：用於運行需要完整 OS 的服務。",{"type":17,"tag":41,"props":177,"children":178},{},[179,184],{"type":17,"tag":45,"props":180,"children":181},{},[182],{"type":23,"value":183},"Containers (Podman)",{"type":23,"value":185},"：用於運行輕量級應用。",{"type":17,"tag":26,"props":187,"children":188},{},[189,191,196],{"type":23,"value":190},"最關鍵的是，我全面採用了 ",{"type":17,"tag":45,"props":192,"children":193},{},[194],{"type":23,"value":195},"Rootless",{"type":23,"value":197}," 方案。\n這意味著不管是 libvirt 還是 Podman，都是以非 root 使用者身份運行。這在安全性上是一個巨大的提升，即使容器被攻破，攻擊者拿到的權限也受到極大限制。Cockpit 對 Rootless 的支援相當完善，讓我可以在 Web 介面上無痛管理這些隔離環境。",{"type":17,"tag":18,"props":199,"children":201},{"id":200},"核心思想四注入靈魂-cockpit-copilot-llm-mcp",[202],{"type":23,"value":203},"核心思想四：注入靈魂 —— Cockpit Copilot (LLM + MCP)",{"type":17,"tag":26,"props":205,"children":206},{},[207],{"type":23,"value":208},"這大概是 v2 架構最「Geek」也最讓我興奮的部分。",{"type":17,"tag":26,"props":210,"children":211},{},[212,214,221,223,229],{"type":23,"value":213},"光有好的架構還不夠，我希望管理伺服器這件事能更「現代化」。既然 LLM 這麼強大，為什麼我要自己去查 ",{"type":17,"tag":215,"props":216,"children":218},"code",{"className":217},[],[219],{"type":23,"value":220},"virsh",{"type":23,"value":222}," 或 ",{"type":17,"tag":215,"props":224,"children":226},{"className":225},[],[227],{"type":23,"value":228},"podman",{"type":23,"value":230}," 的冷門參數？",{"type":17,"tag":26,"props":232,"children":233},{},[234,236,248],{"type":23,"value":235},"於是，我自製了一個專案：",{"type":17,"tag":45,"props":237,"children":238},{},[239],{"type":17,"tag":240,"props":241,"children":245},"a",{"href":242,"rel":243},"https://github.com/hans00/cockpit-copilot-agent",[244],"nofollow",[246],{"type":23,"value":247},"cockpit-copilot-agent",{"type":23,"value":73},{"type":17,"tag":26,"props":250,"children":251},{},[252,254,259],{"type":23,"value":253},"這不只是一個聊天機器人，這是基於 ",{"type":17,"tag":45,"props":255,"children":256},{},[257],{"type":23,"value":258},"MCP (Model Context Protocol)",{"type":23,"value":260}," 打造的系統管理員助手：",{"type":17,"tag":37,"props":262,"children":263},{},[264,274,284],{"type":17,"tag":41,"props":265,"children":266},{},[267,272],{"type":17,"tag":45,"props":268,"children":269},{},[270],{"type":23,"value":271},"MCP 工具包",{"type":23,"value":273},"：我將 Linux 系統管理工具封裝成 MCP tools。",{"type":17,"tag":41,"props":275,"children":276},{},[277,282],{"type":17,"tag":45,"props":278,"children":279},{},[280],{"type":23,"value":281},"LLM 決策",{"type":23,"value":283},"：透過語言模型理解我的自然語言指令（例如：「幫我把那個吃記憶體最兇的 Container 重啟」）。",{"type":17,"tag":41,"props":285,"children":286},{},[287,292],{"type":17,"tag":45,"props":288,"children":289},{},[290],{"type":23,"value":291},"自動執行",{"type":23,"value":293},"：Agent 會透過 MCP 安全地調用系統指令，並將結果回傳給我。",{"type":17,"tag":26,"props":295,"children":296},{},[297,299,305,307,313,315,320],{"type":23,"value":298},"以前我要 SSH 進去敲 ",{"type":17,"tag":215,"props":300,"children":302},{"className":301},[],[303],{"type":23,"value":304},"podman stats",{"type":23,"value":306}," 然後 ",{"type":17,"tag":215,"props":308,"children":310},{"className":309},[],[311],{"type":23,"value":312},"podman restart \u003Cid>",{"type":23,"value":314},"，現在我只需要在 Cockpit 裡跟我的 Copilot 說一句話。它不僅是介面，更是我的 ",{"type":17,"tag":45,"props":316,"children":317},{},[318],{"type":23,"value":319},"Sidecar Admin",{"type":23,"value":73},{"type":17,"tag":322,"props":323,"children":325},"vue-mermaid",{"code":324},"\ngraph TD\n User((User)) -->|Natural Language| Agent[Cockpit Copilot Agent]\n Agent -->|MCP Protocol| Tools[MCP Tools]\n Tools -->|Command| System[Ubuntu System]\n System --> Podman\n System --> Libvirt\n System --> ZFS\n subgraph Cockpit\n     Agent\n end\n",[],{"type":17,"tag":18,"props":327,"children":329},{"id":328},"結語",[330],{"type":23,"value":328},{"type":17,"tag":26,"props":332,"children":333},{},[334],{"type":23,"value":335},"HomeLab v2.0 不僅是一次硬體架構的縮減，更是一次管理思維的升級。",{"type":17,"tag":26,"props":337,"children":338},{},[339],{"type":23,"value":340},"從「多機堆疊」回歸到「單機極致」，從「手動維護」進化到「AI 輔助」。這套 Ubuntu + ZFS + Cockpit + AI Copilot 的組合，完美解決了我舊架構的功耗痛點，同時也讓系統管理變得前所未有的有趣。",{"type":17,"tag":26,"props":342,"children":343},{},[344],{"type":23,"value":345},"如果你也厭倦了維護龐大虛擬化叢集的疲憊感，或許這套 All-in-One 的智慧化方案，會是你下一個 HomeLab 的靈感來源。",{"title":8,"searchDepth":347,"depth":347,"links":348},2,[],"markdown","content:articles:homelab-v2.md","content","articles/homelab-v2.md","articles/homelab-v2","md",{"_path":356,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":357,"description":358,"category":11,"date":359,"body":360,"_type":349,"_id":621,"_source":351,"_file":622,"_stem":623,"_extension":354},"/articles/home-lab","我的 home lab","我的自管伺服器的架構與解決辦法","2022-01-01",{"type":14,"children":361,"toc":604},[362,367,371,377,382,387,392,436,441,446,452,457,462,467,473,478,483,488,494,499,505,510,515,519,525,530,536,541,548,553,558,564,586,592],{"type":17,"tag":18,"props":363,"children":365},{"id":364},"實體機架構",[366],{"type":23,"value":364},{"type":17,"tag":322,"props":368,"children":370},{"code":369},"\ngraph LR\n isp(ISP) --- router\n router((路由器)) --- storage & vm-server & home\n home[Home Group]\n subgraph Server Group\n     storage[儲存] == Fiber === vm-server\n     subgraph DMZ\n         vm-server[VM]\n     end\n end\n",[],{"type":17,"tag":372,"props":373,"children":375},"h2",{"id":374},"路由器",[376],{"type":23,"value":374},{"type":17,"tag":26,"props":378,"children":379},{},[380],{"type":23,"value":381},"我採用了 RouterOS，因為可以使用相對低的成本做到專業路由器的設定。",{"type":17,"tag":372,"props":383,"children":385},{"id":384},"儲存",[386],{"type":23,"value":384},{"type":17,"tag":26,"props":388,"children":389},{},[390],{"type":23,"value":391},"在眾多專為儲存設計的作業系統中我最終採用 DIY 建置的方案。",{"type":17,"tag":163,"props":393,"children":394},{},[395],{"type":17,"tag":41,"props":396,"children":397},{},[398,400],{"type":23,"value":399},"Debian\n",{"type":17,"tag":163,"props":401,"children":402},{},[403,408,413,418],{"type":17,"tag":41,"props":404,"children":405},{},[406],{"type":23,"value":407},"XanMod kernel LTS",{"type":17,"tag":41,"props":409,"children":410},{},[411],{"type":23,"value":412},"OpenZFS",{"type":17,"tag":41,"props":414,"children":415},{},[416],{"type":23,"value":417},"iSCSI: LIO",{"type":17,"tag":41,"props":419,"children":420},{},[421,423],{"type":23,"value":422},"Cockpit\n",{"type":17,"tag":163,"props":424,"children":425},{},[426],{"type":17,"tag":41,"props":427,"children":428},{},[429],{"type":17,"tag":240,"props":430,"children":433},{"href":431,"rel":432},"https://github.com/optimans/cockpit-zfs-manager",[244],[434],{"type":23,"value":435},"ZFS Manager",{"type":17,"tag":26,"props":437,"children":438},{},[439],{"type":23,"value":440},"原本是想選擇 FreeNAS，畢竟 iXsystems 在 FreeNAS 上做了不少優化。但 FreeBSD 的社群正在萎縮、維護速度趕不上 Linux。",{"type":17,"tag":26,"props":442,"children":443},{},[444],{"type":23,"value":445},"使用 XanMod kernel 是因為在加上 performance profile 之後擁有更佳的性能。\n而 iSCSI 採用 LIO 是因為它是執行在 kernel 內、支援各種協定，且它可以直接與 Proxmox VE 整合 (ZFS over iSCSI)。",{"type":17,"tag":447,"props":448,"children":450},"h3",{"id":449},"openzfs",[451],{"type":23,"value":412},{"type":17,"tag":26,"props":453,"children":454},{},[455],{"type":23,"value":456},"非常強大，支援快照、區塊壓縮、RAM cache (ARC)、SSD cache (L2ARC) 等功能，且自有的 zpool 管理方式非常方便。",{"type":17,"tag":447,"props":458,"children":460},{"id":459},"cockpit",[461],{"type":23,"value":148},{"type":17,"tag":26,"props":463,"children":464},{},[465],{"type":23,"value":466},"近期社群非常活躍的 Web 管理介面專案，它可以很容易的安裝第三方插件。",{"type":17,"tag":372,"props":468,"children":470},{"id":469},"vm",[471],{"type":23,"value":472},"VM",{"type":17,"tag":26,"props":474,"children":475},{},[476],{"type":23,"value":477},"我選擇了 Proxmox VE，因為它是開源的而且有非常方便管理的 Web UI。\n並且由於該主機是自組的、沒有辦法放那麼多硬碟，所以我把儲存分離出去，為了保障資料傳輸還設定了直連光纖。",{"type":17,"tag":26,"props":479,"children":480},{},[481],{"type":23,"value":482},"所有的應用服務都是在這台上面開 LXC 或 VM 來解決。",{"type":17,"tag":372,"props":484,"children":486},{"id":485},"分區管制",[487],{"type":23,"value":485},{"type":17,"tag":447,"props":489,"children":491},{"id":490},"home-group",[492],{"type":23,"value":493},"Home group",{"type":17,"tag":26,"props":495,"children":496},{},[497],{"type":23,"value":498},"供給家裡使用，設定 DHCP 與 NAT 且獨立的網段。",{"type":17,"tag":447,"props":500,"children":502},{"id":501},"server-group",[503],{"type":23,"value":504},"Server group",{"type":17,"tag":26,"props":506,"children":507},{},[508],{"type":23,"value":509},"供給伺服器使用，獨立的網段且有分區管制，僅 PVE 內。",{"type":17,"tag":18,"props":511,"children":513},{"id":512},"應用層架構",[514],{"type":23,"value":512},{"type":17,"tag":322,"props":516,"children":518},{"code":517},"\ngraph TB\n envoy -- WAF --> iis & http1 & http2\n envoy --> other-services\n rdp-proxy --> rdp & vnc\n subgraph front-vm [Bastion host VM]\n     envoy(envoy proxy)\n     rdp-proxy(RDP proxy)\n end\n subgraph windows-vm [Windows VM]\n     rdp(RDP)\n     iis(IIS)\n end\n subgraph linux-1 [Linux VM 1]\n     vnc(VNC)\n     http1(HTTP)\n end\n subgraph linux-2 [Linux VM 2]\n     http2(HTTP)\n end\n subgraph linux-3 [Linux VM 3]\n     other-services(Other services)\n end\n",[],{"type":17,"tag":372,"props":520,"children":522},{"id":521},"bastion-host",[523],{"type":23,"value":524},"Bastion host",{"type":17,"tag":26,"props":526,"children":527},{},[528],{"type":23,"value":529},"採用類似雲端的管理方式，由 bastion host 統一對外。",{"type":17,"tag":447,"props":531,"children":533},{"id":532},"envoy-proxy",[534],{"type":23,"value":535},"envoy proxy",{"type":17,"tag":26,"props":537,"children":538},{},[539],{"type":23,"value":540},"envoy proxy 是 CNCF 的一個專案，就是專門進行高效能代理服務用的伺服器。",{"type":17,"tag":542,"props":543,"children":545},"h4",{"id":544},"modsecurity-filter",[546],{"type":23,"value":547},"ModSecurity filter",{"type":17,"tag":26,"props":549,"children":550},{},[551],{"type":23,"value":552},"為了安全性，我在 HTTP 服務加上 ModSecurity filter 作為 WAF。",{"type":17,"tag":26,"props":554,"children":555},{},[556],{"type":23,"value":557},"這個模組雖然有找到現成的，但似乎有段時間沒維護且留下了一些 TODO code，所以我花了時間整理了一下。envoy proxy 內部程式碼似乎沒有文件，於是我是一層一層追蹤來找到正確寫法的。",{"type":17,"tag":447,"props":559,"children":561},{"id":560},"rdp-proxy",[562],{"type":23,"value":563},"RDP proxy",{"type":17,"tag":26,"props":565,"children":566},{},[567,569,576,578,584],{"type":23,"value":568},"我找到了 ",{"type":17,"tag":240,"props":570,"children":573},{"href":571,"rel":572},"https://github.com/wallix/redemption",[244],[574],{"type":23,"value":575},"redemption",{"type":23,"value":577}," 這個專案可以在 Linux 上建置統一對外用的 proxy，所以我選用這個並依他的 ",{"type":17,"tag":215,"props":579,"children":581},{"className":580},[],[582],{"type":23,"value":583},"passthrough.py",{"type":23,"value":585}," 範本加寫了限制連線範圍的規則。",{"type":17,"tag":542,"props":587,"children":589},{"id":588},"auto-ban",[590],{"type":23,"value":591},"auto ban",{"type":17,"tag":26,"props":593,"children":594},{},[595,597,602],{"type":23,"value":596},"在 ",{"type":17,"tag":215,"props":598,"children":600},{"className":599},[],[601],{"type":23,"value":583},{"type":23,"value":603}," 這邊辨識連線目標為範圍外時會記錄下來，再透過 fail2ban 進行封鎖。",{"title":8,"searchDepth":347,"depth":347,"links":605},[606,607,612,613,617],{"id":374,"depth":347,"text":374},{"id":384,"depth":347,"text":384,"children":608},[609,611],{"id":449,"depth":610,"text":412},3,{"id":459,"depth":610,"text":148},{"id":469,"depth":347,"text":472},{"id":485,"depth":347,"text":485,"children":614},[615,616],{"id":490,"depth":610,"text":493},{"id":501,"depth":610,"text":504},{"id":521,"depth":347,"text":524,"children":618},[619,620],{"id":532,"depth":610,"text":535},{"id":560,"depth":610,"text":563},"content:articles:home-lab.md","articles/home-lab.md","articles/home-lab",1771108032996]